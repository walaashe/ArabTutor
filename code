import openai
import gradio as gr
import csv
from datetime import datetime
import os

# âœ… Ø¥Ø¹Ø¯Ø§Ø¯ API
openai.api_key = "sk-"

# âœ… Ø§Ø³Ù… Ù…Ù„Ù CSV
log_file_path = "log.csv"

# âœ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ù Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§
if not os.path.exists(log_file_path):
    with open(log_file_path, mode='w', encoding='utf-8-sig', newline='') as file:
        writer = csv.writer(file)
        writer.writerow(["ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®", "ğŸ“˜ Ø§Ù„Ù…Ø§Ø¯Ø©", "â“ Ø§Ù„Ø³Ø¤Ø§Ù„", "âœ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©", "ğŸš© ÙÙ„Ø§Ø¬"])

# âœ… Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§Ù„Ø¨
def tutor_response(user_input, subject):
    client = openai.OpenAI(api_key=openai.api_key)

    if subject == "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©":
        system_prompt = "Ø£Ù†Øª Ù…Ø¹Ù„Ù… Ù…ØªØ®ØµØµ ÙÙŠ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ØªØ´Ø±Ø­ Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø¨Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ© Ù…Ø¨Ø³Ø·Ø© Ø­Ø³Ø¨ Ù…Ø³ØªÙˆØ§Ù‡Ù…."
    elif subject == "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª":
        system_prompt = "Ø£Ù†Øª Ù…Ø¹Ù„Ù… Ø±ÙŠØ§Ø¶ÙŠØ§Øª ØªØ´Ø±Ø­ Ø§Ù„Ù…ÙØ§Ù‡ÙŠÙ… ÙˆØ§Ù„Ø£ÙÙƒØ§Ø± Ù„Ù„Ø·Ù„Ø§Ø¨ Ø¨Ø£Ø³Ù„ÙˆØ¨ Ø³Ù‡Ù„ ÙˆÙ…Ø¨Ø³Ø·."
    elif subject == "Ø§Ù„Ø¹Ù„ÙˆÙ…":
        system_prompt = "Ø£Ù†Øª Ù…Ø¹Ù„Ù… Ø¹Ù„ÙˆÙ… ØªØ´Ø±Ø­ Ø§Ù„Ù…ÙØ§Ù‡ÙŠÙ… Ø§Ù„Ø¹Ù„Ù…ÙŠØ© Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø³Ù‡Ù„Ø© ÙˆÙ…Ø¨Ø³Ø·Ø© Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³."
    else:
        system_prompt = "Ø£Ù†Øª Ù…Ø¹Ù„Ù… Ø°ÙƒÙŠ ØªØ´Ø±Ø­ Ø£ÙŠ Ù…Ø§Ø¯Ø© Ø¯Ø±Ø§Ø³ÙŠØ© Ø¨Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ© Ù…Ø¨Ø³Ø·Ø© Ù„Ù„Ø·Ù„Ø§Ø¨."

    try:
        response = client.chat.completions.create(
            model="gpt-4",
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_input}
            ],
            temperature=0.7,
            max_tokens=500
        )
        answer_text = response.choices[0].message.content

        # âœ… ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø§Ù„Ù…Ù„Ù
        with open(log_file_path, mode='a', encoding='utf-8-sig', newline='') as file:
            writer = csv.writer(file)
            writer.writerow([datetime.now().strftime("%Y-%m-%d %H:%M:%S"), subject, user_input, answer_text, "No"])
        
        return answer_text, gr.update(visible=True, interactive=True, value="ğŸš© ÙÙ„Ø§Ø¬"), user_input, answer_text, subject
    except Exception as e:
        return f"âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: {str(e)}", gr.update(visible=False), "", "", ""

# âœ… Ø²Ø± Ø§Ù„ÙÙ„Ø§Ø¬ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø£Ø®ÙŠØ±
def flag_answer(temp_question, temp_answer, temp_subject):
    lines = []
    with open(log_file_path, mode='r', encoding='utf-8-sig') as file:
        lines = list(csv.reader(file))

    if len(lines) > 1:
        lines[-1][-1] = "Yes"

    with open(log_file_path, mode='w', encoding='utf-8-sig', newline='') as file:
        writer = csv.writer(file)
        writer.writerows(lines)

    return gr.update(value="âœ… ØªÙ… ØªÙ…ÙŠÙŠØ²Ù‡", interactive=False)

# âœ… ÙˆØ§Ø¬Ù‡Ø© Gradio Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Blocks
with gr.Blocks(title="Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø°ÙƒÙŠ") as iface:
    gr.Markdown("### ğŸ‘¨â€ğŸ« Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©")

    with gr.Row():
        question = gr.Textbox(lines=2, placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§...", label="â“ Ø§Ù„Ø³Ø¤Ø§Ù„")
        subject = gr.Dropdown(choices=["Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª", "Ø§Ù„Ø¹Ù„ÙˆÙ…"], label="ğŸ“˜ Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©", value="Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©")
        send_btn = gr.Button("Ø£Ø±Ø³Ù„ âœ…")

    answer = gr.Textbox(label="âœ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©")
    flag_btn = gr.Button("ğŸš© ÙÙ„Ø§Ø¬", visible=False)

    # âœ… Ø¹Ù†Ø§ØµØ± Ù„Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠÙ… Ù…Ø¤Ù‚ØªÙ‹Ø§
    temp_question = gr.Textbox(visible=False)
    temp_answer = gr.Textbox(visible=False)
    temp_subject = gr.Textbox(visible=False)

    send_btn.click(
        fn=tutor_response,
        inputs=[question, subject],
        outputs=[answer, flag_btn, temp_question, temp_answer, temp_subject]
    )

    flag_btn.click(
        fn=flag_answer,
        inputs=[temp_question, temp_answer, temp_subject],
        outputs=[flag_btn]
    )

# âœ… ØªØ´ØºÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
iface.launch(share=True)
